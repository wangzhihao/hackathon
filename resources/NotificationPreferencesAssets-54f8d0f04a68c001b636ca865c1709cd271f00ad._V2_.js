(function(m){var g=window.AmazonUIPageJS||window.P,p=g._namespace||g.attributeErrors,a=p?p("NotificationPreferencesAssets"):g;a.guardFatal?a.guardFatal(m)(a,window):a.execute(function(){m(a,window)})})(function(m,g,p){m.register("nps-nav",function(){return{changeWindowLocation:function(a){g.location=a},reload:function(){location.reload()},setLocation:function(a){g.history.replaceState?g.history.replaceState("np","",a):location.href=a}}});m.when("A","nps-nav","a-modal").register("nps-common",
function(a,m,k){return{shouldConfirmWindowClose:function(){if(a===p||k===p)return!1;if(a.state("nps-page-state").editModeActive)return!0;var b=k.get("edit-contact-popover");return b&&b.isActive()?!0:!1},showError:function(b,a){null!==a&&b.find(".a-alert-content").html(a);b.slideDown()},getCachedTranslation:function(b){return a.$(".string-translation."+b).html().trim()},loadTabViaAjax:function(b,c,f,d){var e=a.$(".tab-content."+b+"-tab .tab-loading-spinner"),l=a.$(".tab-content."+b+"-tab .tab-content-placeholder");
if(!l.data("tab-loaded")||d)l.html(""),e.removeClass("aok-hidden"),a.get(c,{success:function(b,a,d){e.addClass("aok-hidden");l.html(b);l.data("tab-loaded",!0);f&&f()},error:function(b,a,d){e.addClass("aok-hidden");console.log("AJAX error: "+d);l.html("An error has occured: "+d);403===b.http.status?m.reload():l.html("An error has occured: "+d)}})},openWindow:function(b,a,f,d,e){null===e&&(e="no");g.open(b,d,"height="+f+",width="+a+",left="+(screen.width-a)/2+",top="+(screen.height-f)/2+",status=no,toolbar="+
e+",menubar=no,location=no,resizable=yes")}}});m.when("A","nps-nav","nps-common","a-button","a-checkbox","a-popover","a-modal").register("nps-preferences",function(a,g,k){return{test:function(b){console.log("test()");console.log(b);return b},initExpander:function(b){var c=this,f=a.$(b).data("a-expander-name"),d=a.$(b).data("section-name");a.on("a:expander:"+f+":toggle:expand",function(e){e.expander.$expander.addClass("section-expanded");e.expander.$expander.removeClass("section-collapsed");
c.sectionExpanded(d)});a.on("a:expander:"+f+":toggle:collapse",function(e){e.expander.$expander.addClass("section-collapsed");e.expander.$expander.removeClass("section-expanded");c.sectionCollapsed(d)})},loadPreferencesTab:function(b){var c=this;k.loadTabViaAjax(b,"/notifications/preferences/partials/preferences",function(){a.$(".section-expander").each(function(){c.initExpander(this)});c.expandAllSections()});g.setLocation("/notifications/preferences")},sectionExpanded:function(b){a.$("."+b+"-section .section-content").data("section-loaded")||
this.reloadSection(b)},sectionCollapsed:function(b){},clearSection:function(b){a.$("."+b+"-section .section-content").html("")},replaceSectionContent:function(b,c){a.$("."+b+"-section .section-content").html(c)},replaceSectionContentAjax:function(b,a,f,d){this.replaceAndMergeSectionContentAjax(b,{},a,f,d)},checkForEndpointDeliverabilityIssues:function(b){-1!==b.indexOf("endpoint-deliverability-issue-icon")&&a.$(".endpoint-deliverability-issue-msg").slideDown()},replaceAndMergeSectionContentAjax:function(b,
c,f,d,e){var l=this,h=a.$("."+b+"-section .section-content"),n=a.$("."+b+"-section .section-loading-spinner");this.clearSection(b);n.removeClass("aok-hidden");a.get(f,{params:c,success:function(e,a,c){n.addClass("aok-hidden");h.data("section-loaded",!0);l.replaceSectionContent(b,e);d&&d(e,a,c);l.checkForEndpointDeliverabilityIssues(e)},error:function(a,d,c){n.addClass("aok-hidden");console.log("AJAX error: "+c);403===a.http.status?g.reload():(l.replaceSectionContent(b,"An error has occured: "+c),
e&&e(a,d,c))}})},reloadSection:function(a,c,f){this.replaceSectionContentAjax(a,"/notifications/preferences/partials/preferenceSectionContent/"+a,c,f)},toggleEditButton:function(b,c){a.$("."+b+"-section .edit-button-wrapper").toggleClass("aok-hidden",!c)},toggleEditButtons:function(b){a.$(".edit-button-wrapper").toggleClass("aok-hidden",!b)},toggleSaveCancelButtons:function(b,c){a.$("."+b+"-section .save-cancel-button-wrapper").toggleClass("aok-hidden",!c)},showEditSection:function(b){var c=this;
c.toggleEditButton(b,!1);this.replaceSectionContentAjax(b,"/notifications/preferences/partials/preferenceSectionContent/"+b+"/edit",function(){c.toggleSaveCancelButtons(b,!0);a.state("nps-page-state",{editModeActive:!0});a.$(".preference-expansion-section[data-section-name='"+b+"']").find(".preference-set-group-input-container").each(function(){var b=a.$(this).data("preferenceSetGroupName");c.resetPreferenceSetGroupMinMax(b)})},function(){c.toggleEditButton(b,!0)})},cancelEditSection:function(b){var c=
this;c.toggleSaveCancelButtons(b,!1);this.reloadSection(b,function(){c.toggleEditButton(b,!0);a.state("nps-page-state",{editModeActive:!1})})},retrieveDataFromSection:function(b){b=a.$("form[data-section-name='"+b+"']");var c={};a.each(b.serializeArray(),function(a){c[a.name]=a.value});return c},saveSection:function(b){var c=a.$("form[data-section-name='"+b+"']"),f=a.$("."+b+"-section .section-content"),d=this.retrieveDataFromSection(b),e=this,l=a.$("."+b+"-section .section-loading-spinner");this.clearSection(b);
l.removeClass("aok-hidden");this.toggleSaveCancelButtons(b,!1);a.post(c.prop("action"),{params:d,success:function(a,d,c){l.addClass("aok-hidden");e.replaceSectionContent(b,a);a=!1;(d=f.find(".form-has-errors"))&&(a="true"===d.val());a||(e.toggleSaveCancelButtons(b,!1),e.toggleEditButton(b,!0))},error:function(a,d,c){l.addClass("aok-hidden");e.toggleSaveCancelButtons(b,!0);console.log("AJAX error: "+c);e.replaceSectionContent(b,"An error has occured: "+c);403===a.http.status&&g.reload()}});a.state("nps-page-state",
{editModeActive:!1})},refreshAllSectionsInViewWithSms:function(){var b=this;a.$(".preference-expansion-section").filter(function(){return!!a.$(this).find(".sms-preference-row").length}).filter(function(){return!a.$(this).find(".edit-button-wrapper").hasClass("aok-hidden")}).each(function(){var c=a.$(this);b.reloadSection(c.data("sectionName"))})},updateAllSectionsSms:function(){this.refreshAllSectionsInViewWithSms();var b=this,c=a.$(".preference-expansion-section").filter(function(){return!!a.$(this).find(".sms-preference-row").length}),
f=this.retrieveDataFromSection;c.filter(function(){return a.$(this).find(".edit-button-wrapper").hasClass("aok-hidden")}).each(function(){var d=a.$(this).data("sectionName"),e=f(d);b.replaceAndMergeSectionContentAjax(d,e,"/notifications/preferences/partials/preferenceSectionContent/"+d+"/mergeEdit/",function(){b.toggleSaveCancelButtons(d,!0)})})},addPreferenceSet:function(b){var c=a.$(".preference-set-group-input-container[data-preference-set-group-name='"+b+"']"),f=a.$(".input-template-container[data-preference-set-group-name='"+
b+"']"),d=parseInt(a.$(".max-preference-sets-field[data-preference-set-group-name='"+b+"']").val(),10);if(!isNaN(d)&&0<d&&this.getNumberOfPreferenceSets(b)>=d)console.log("Maximum preference sets");else{d=a.state("nps-page-state").newPreferenceSetIndex;"undefined"===typeof d&&(d={});var e=0;b in d&&(e=d[b]+1);f=f.children().clone(!0);f.find(".input-template-field").each(function(){var b=a.$(this),d=b.data("name-template").replace("$_index_$",e);b.prop("name",d);b.data("name-template","");b.removeClass("input-template-field")});
d[b]=e;a.state("nps-page-state",{newPreferenceSetIndex:d});c.append(f);this.resetPreferenceSetGroupMinMax(b)}},removePreferenceSet:function(b,c){var f=a.$(".preference-set-group-input-container[data-preference-set-group-name='"+b+"']"),d=a.$(".preference-set-container[data-preference-set-name='"+c+"']"),f=f.find(".preference-set-removed-input[value!='true']");d.find(".preference-set-value-input").val("");d.find(".preference-set-removed-input").val("true");d.data("removed","true");this.resetPreferenceSetGroupMinMax(b);
d.hide();1===f.size()&&this.addPreferenceSet(b)},removeNewPreferenceSet:function(a,c){c.remove();this.resetPreferenceSetGroupMinMax(a)},getNumberOfPreferenceSets:function(b){return a.$(".preference-set-group-input-container[data-preference-set-group-name='"+b+"']").find(".preference-set-container").filter(function(){return"true"!==a.$(this).data("removed")}).size()},resetPreferenceSetGroupMinMax:function(b){var c=a.$(".preference-set-group-input-container[data-preference-set-group-name='"+b+"']"),
f=this.getNumberOfPreferenceSets(b),d=parseInt(a.$(".max-preference-sets-field[data-preference-set-group-name='"+b+"']").val(),10),c=c.find(".a-declarative[data-action='remove-preference-set'], .a-declarative[data-action='remove-new-input']");1>=f?c.addClass("aok-hidden"):c.removeClass("aok-hidden");!isNaN(d)&&0<d&&(b=a.$(".add-more-row[data-preference-set-group-name='"+b+"'] .add-more-link"),f>=d?b.addClass("disabled"):b.removeClass("disabled"))},expandAllSections:function(){a.$(".section-expander:not(.section-expanded) .a-declarative[data-action='a-expander-toggle']").click()}}});
m.when("A","nps-nav","nps-common","a-button","a-checkbox","a-modal").register("nps-contacts",function(a,g,k,b,c,f){return{verificationCodeHandle:null,pendingContactSave:null,loadContactsTab:function(a,e){k.loadTabViaAjax("contacts","/notifications/preferences/partials/contacts",e,a);g.setLocation("/notifications/preferences/contacts")},contactEditFormChanged:function(d){d=this.validateSmsForm(d.serializeArray());var e=b(".smsContinueBtn"),l=b(".contactSaveBtn");c(".contact-sms-enabled");
d?this.verificationRequired()?(e.enable(),l.disable(),a.$("#edit-contact-form .default-button-row").toggleClass("aok-hidden",!0),a.$("#edit-contact-form .sms-registration-button-row").toggleClass("aok-hidden",!1)):(e.disable(),l.enable(),a.$("#edit-contact-form .default-button-row").toggleClass("aok-hidden",!1),a.$("#edit-contact-form .sms-registration-button-row").toggleClass("aok-hidden",!0)):(e.disable(),l.disable())},verificationRequired:function(){var b=!1,e=a.state("nps-page-state");if(!1!==
!!e.requiresPinVerification){!0===e.contactPhoneChanged&&(b=!0);var e=!0===e.smsEnabledChanged,l=c(".contact-sms-enabled").isChecked();e&&l&&(b=!0)}return b},contactPhoneChanged:function(){a.state("nps-page-state",{contactPhoneChanged:!0})},toggleContactSms:function(){a.state("nps-page-state",{smsEnabledChanged:!0})},transmitContactUpdate:function(b,e,c,f){a.ajax("/notifications/preferences/contacts/"+b+"/save",{method:"post",params:e,success:function(b,e,d){b.success?(c(),a.trigger("contact-updated")):
f(b.errorMessage)},error:function(a,b,e){f(e)}})},saveContact:function(){var a=this,b=f.get("edit-contact-popover"),c=b.getContent().find("#edit-contact-form"),h=b.getContent().find(".section-loading-spinner");h.removeClass("aok-hidden");c.addClass("hide");var n=c.serializeArray(),g=c.attr("data-contact-id");this.transmitContactUpdate(g,n,function(){b.hide();a.loadContactsTab(!0)},function(a){h.addClass("aok-hidden");c.removeClass("hide");var d=b.getContent().find("#edit-error");k.showError(d,a)})},
verifySmsAndSaveContact:function(){var a=this,b=f.get("edit-contact-popover"),c=b.getContent().find("#sms-verify-pin").val(),h=b.getContent().find(".section-loading-spinner"),n=b.getContent().find(".active-edit-modal-form");h.removeClass("aok-hidden");n.addClass("hide");c=this.pendingContactSave.concat([{name:"codeHandle",value:this.verificationCodeHandle},{name:"verCode",value:c}]);this.transmitContactUpdate(this.pendingContactId,c,function(){b.hide();a.loadContactsTab(!0)},function(a){a=b.getContent().find("#edit-error");
k.showError(a,k.getCachedTranslation("seller_notifications_retriable_pin_verification_failure_exception"));h.addClass("aok-hidden");n.removeClass("hide")})},continueEditContact:function(){var a=this,b=f.get("edit-contact-popover"),c=b.getContent().find("#edit-contact-form").attr("data-contact-id"),h=b.getContent().find("#edit-contact-form").serializeArray(),n=b.getContent().find(".section-loading-spinner"),g=b.getContent().find(".active-edit-modal-form"),m=b.getContent().find("#edit-error");this.validateSmsForm(h)&&
(n.removeClass("aok-hidden"),g.addClass("hide"),this.pendingContactSave=h,this.pendingContactId=c,this.verificationCodeHandle=null,this.sendVerificationCode(h,function(f,h,n){b.update({url:"/notifications/preferences/partials/contacts/"+c+"/edit-sms-registration"});a.verificationCodeHandle=f.codeHandle},function(b,a,e){a=k.getCachedTranslation("seller_notifications_permanent_pin_request_failure_exception");400===b.http.status?a=k.getCachedTranslation("seller_notifications_please_enter_a_valid_phoseller_notifications_number"):
429===b.http.status&&(a=JSON.parse(b.http.response).error);k.showError(m,a);n.addClass("aok-hidden");g.removeClass("hide")}))},resendCode:function(){var a=this,b=f.get("edit-contact-popover"),c=b.getContent().find(".section-loading-spinner"),h=b.getContent().find(".active-edit-modal-form");h.serializeArray();c.removeClass("aok-hidden");h.addClass("hide");this.sendVerificationCode(this.pendingContactSave,function(b){a.verificationCodeHandle=b.codeHandle;c.addClass("aok-hidden");h.removeClass("hide")},
function(a,d,f){d=k.getCachedTranslation("seller_notifications_permanent_pin_request_failure_exception");429===a.http.status&&(d=JSON.parse(a.http.response).error);c.addClass("aok-hidden");h.removeClass("hide");a=b.getContent().find("#edit-error");k.showError(a,d)})},sendVerificationCode:function(b,e,c){a.ajax("/notifications/preferences/contacts/begin-sms-verification",{method:"post",params:b,success:function(b,a,c){e(b,a,c)},error:function(b,a,e){c(b,a,e)}})},removePhoneFromContact:function(b,e){if(confirm(k.getCachedTranslation("seller_notifications_delete_mobile_preferences_confirmation"))){var c=
this,h=f.get("edit-contact-popover"),g=h.getContent().find("#edit-error"),m=h.getContent().find("#edit-contact-form").serializeArray(),p=h.getContent().find(".section-loading-spinner"),q=h.getContent().find(".active-edit-modal-form");p.removeClass("aok-hidden");q.addClass("hide");a.ajax("/notifications/preferences/contacts/"+b+"/remove-sms",{method:"post",params:m,success:function(b,a,d){b.success?(h.hide(),c.loadContactsTab(!0),e&&e()):(k.showError(g,b.errorMessage),p.addClass("aok-hidden"),q.removeClass("hide"))},
error:function(b,a,e){k.showError(g,e);p.addClass("aok-hidden");q.removeClass("hide")}})}},validateSmsForm:function(b){var e=!1,c=!1,f=!1,g=!1;a.$.each(b,function(){switch(this.name){case "smsDeliveryWindow.anytime":f="true"===this.value;break;case "smsDeliveryWindow.timezone":c=!!this.value;break;case "agreement-checkbox":g="true"===this.value}});f||(e=e||!c);return!(e||!g)}}});m.when("A","nps-nav","nps-common","nps-preferences","nps-contacts").register("nps-init",function(a,m,k,b,c){return{init:function(){var f=
a.$,d=this;g.addEventListener("beforeunload",function(b){if(k.shouldConfirmWindowClose())return b.returnValue="You may lose unsaved information if you close this window."});f(g).bind("popstate",function(b){});g.openSMSTerms=function(){g.open("/gp/help/help-popup.html/?itemID=201024210","_blank","height=530,width=350,status=no,toolbar=no,menubar=no,location=no,resizable=yes")};a.declarative("edit-section","click",function(a){a.$event.stopPropagation();var c=a.data.urlOverride;c?m.changeWindowLocation(c):
b.showEditSection(a.data.sectionName)});a.declarative("cancel-edit-section","click",function(a){a.$event.stopPropagation();b.cancelEditSection(a.data.sectionName)});a.declarative("save-edit-section","click",function(a){a.$event.stopPropagation();a.$event.preventDefault();b.saveSection(a.data.sectionName)});a.declarative("add-more","click",function(a){b.addPreferenceSet(a.data.preferenceSetGroupName)});a.declarative("remove-preference-set","click",function(a){b.removePreferenceSet(a.data.preferenceSetGroupName,
a.data.preferenceSetName)});a.declarative("remove-new-input","click",function(a){b.removeNewPreferenceSet(a.data.preferenceSetGroupName,a.$target.parents(".new-input-row"))});a.$(".section-expander").each(function(){b.initExpander(this)});a.on("a:tabs:tabs:preferences:select",function(a){b.loadPreferencesTab(a.selectedTab.tabName)});a.declarative("test-popover","click",function(a){b.test(a)});a.on("a:tabs:tabs:contacts:select",function(a){c.loadContactsTab()});a.declarative("change-contact-phone",
"change",function(a){c.contactPhoneChanged()});a.declarative("load-edit-contact","click",function(b){f("#contacts-tab").click();b=a.$(".primary-contact-row .contact-actions-column .edit-contact-link");0<b.length?b.click():c.loadContactsTab(!0,function(){a.$(".primary-contact-row .contact-actions-column .edit-contact-link").click()})});a.declarative("enable-contact-sms","change",function(a){c.toggleContactSms()});a.declarative("contact-edit-form","change",function(a){c.contactEditFormChanged(f(a.$currentTarget).find("#edit-contact-form"))});
a.declarative("save-contact","click",function(a){c.saveContact()});a.declarative("save-contact-with-sms","submit",function(a){c.verifySmsAndSaveContact()});a.declarative("remove-sms","click",function(a){c.removePhoneFromContact(a.data.contactId,function(){b.updateAllSectionsSms()})});a.declarative("continue-edit-contact","click",function(a){c.continueEditContact(a)});a.declarative("resend-sms-code","click",function(a){c.resendCode()});a.on("a:popover:ajaxContentLoaded:edit-contact-popover",function(a){d.initializeContactModal(a.popover)});
a.on("contact-updated",function(){b.updateAllSectionsSms()});a.on("a:popover:afterHide:edit-contact-popover",function(a){a=a.popover;var b=a.getContent().find(".active-edit-modal-form").attr("data-contact-id");b!==p&&a.update({url:"/notifications/preferences/partials/contacts/"+b+"/edit"})});a.declarative("open-window","click",function(a){k.openWindow(a.data.windowUrl,a.data.windowWidth,a.data.windowHeight,"npspopup")});b.expandAllSections()},initializeContactModal:function(b){var c={};b.getContent().find(".nps-page-state").each(function(){c[this.name]=
"true"===this.value});a.state("nps-page-state",c);b.getContent().find(".new-phone-number").html(this.phoneToVerify)}}});m.when("nps-init","ready").execute("ready-init",function(a){a.init()})});